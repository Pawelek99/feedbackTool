<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Feedback tool</title>

		<link
			rel="stylesheet"
			href="//use.fontawesome.com/releases/v5.13.0/css/all.css"
		/>
		<link rel="stylesheet" href="/styles/global/global.css" />
		<link rel="stylesheet" href="/styles/room/room.css" />
		<link rel="stylesheet" href="/styles/global/popup.css" />
		<script defer src="/public/refresh.js"></script>
	</head>
	<body>
		<div class="wrapper">
			<div class="header">
				<p class="title"><%= room.name %></p>
				<button class="button" id="markReady" <%= room.ready ? 'disabled' : '' %> onclick="markReady()">Ready</button>
			</div>

			<% if (room.lists.length > 0) { %> 
				<div class="listsContainer" id="listsContainer">
					<% room.lists.forEach(function(list) { %>
					<div class="list" data-id="<%= list.id %>">
						<h3 class="list__title"><%= list.name %></h3>
						<div class="notesContainer">
							<% if (!room.ready) { %> 
								<a href="#popupAddNote" data-listId="<%= list.id %>" class="button addNote">
									Add new note <i class="fas fa-plus"></i>
								</a>
							<% } %>
							<% list.notes.forEach(function(note) { %>
							<div class="note">
								<%= note %>
							</div>
							<%}) %>
						</div>
					</div>
					<%}) %>
				</div>
			<% } else { %>
				<div class="emptyHolder">
					<img src="/public/alone.svg" alt="Alone">
					<span class="title">You're here alone. Wait for others to join</span>
				</div>
			<% } %>
		</div>

		<div id="popupAddNote" class="overlay">
			<div class="popup">
				<p class="title">Add a note</p>
				<a class="close" href="#">&times;</a>
				<div class="content">
					<label for="noteContent">Note content</label>
					<textarea
						type="text"
						id="noteContent"
						name="noteContent"
						rows="5"
					></textarea>
					<button id="createNote" class="button submitBtn">Submit</button>
				</div>
			</div>
		</div>

		<script>
			let listId;

			const markReady = async () => {
				await fetch('<%= process.env.URL %>/api/rooms/<%= room.id %>/ready', { method: 'PATCH' });
				window.location.reload();
			};

			if(window.location.hash && !listId) {
				window.location.href = window.location.pathname;
			}

			const createNote = async () => {
				const noteContent = document.querySelector('#noteContent').value;
				const requestBody = {
					listId,
					note: noteContent,
				}
				if(requestBody && requestBody.listId && requestBody.note.length) {
					await fetch('<%= process.env.URL %>/api/rooms/<%= room.id %>/addNote', { 
						method: 'PATCH', 
						body: JSON.stringify(requestBody), 
						headers: {
							'Content-Type': 'application/json'
						}, 
					});
					listId = undefined;
					window.location.href = window.location.pathname;
				}
			}
		
			document.querySelectorAll('a.addNote').forEach(btn => {
				btn.addEventListener('click', function (e) {
					listId = e.target.getAttribute('data-listId');
				});
			});

			document.addEventListener('click', (e) => {
				if (e.target && e.target.id === 'createNote') {
					createNote();
				}
			});
		</script>
	</body>
</html>

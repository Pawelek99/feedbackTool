<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Feedback tool</title>

		<link
			rel="stylesheet"
			href="//use.fontawesome.com/releases/v5.13.0/css/all.css"
		/>
		<link rel="stylesheet" href="/styles/global/global.css" />
		<link rel="stylesheet" href="/styles/room/room.css" />
		<link rel="stylesheet" href="/styles/global/popup.css" />
	</head>
	<body>
		<script>
			const markReady = () => {
				fetch('http://localhost:8080/api/rooms/<%= room.id %>/ready', { method: 'PATCH' });
				document.getElementById('markReady').classList.push('tapped');
			};
		</script>
		<div class="wrapper">
			<div class="header">
				<p class="title">My lists</p>
				<button class="button" id="markReady" <%= room.ready ? 'disabled' : '' %> onclick="markReady()">Ready</button>
			</div>

			<div class="listsContainer" id="listsContainer">
				<% room.lists.forEach(function(list) { %>
				<div class="list" data-id="<%= list.id %>">
					<h3 class="list__title"><%= list.title %></h3>
					<div class="notesContainer">
						<a href="#popupAddNote" data-listId="<%= list.id %>" class="button addNote">
							Add new note <i class="fas fa-plus"></i>
						</a>
						<% list.notes.forEach(function(note) { %>
						<div class="note">
							<%= note %>
						</div>
						<%}) %>
					</div>
				</div>
				<%}) %>
			</div>
		</div>

		<div id="popupAddNote" class="overlay">
			<div class="popup">
				<p class="title">Add a note</p>
				<a class="close" href="#">&times;</a>
				<div class="content">
					<label for="noteContent">Note content</label>
					<textarea
						type="text"
						id="noteContent"
						name="noteContent"
						rows="5"
					></textarea>
					<button id="createNote" class="button submitBtn">Submit</button>
				</div>
			</div>
		</div>

		<script>
			const createNote = () => {
				const noteContent = document.querySelector('#noteContent').value;
				const { listId } = history.state;
				const requestBody = {
					listId,
					note: noteContent,
				}
				fetch('http://localhost:8080/api/rooms/<%= room.id %>/addNote', { method: 'PATCH', body:requestBody });
				document.querySelector('#noteContent').value = '';
			}
		
			document.querySelectorAll('a.addNote').forEach(btn => {
				btn.addEventListener('click', function (e) {
					listId = e.target.getAttribute('data-listId');
					history.pushState({ listId }, null, '/room/<%= room.id %>#popupAddNote');
				});
			});

			document.addEventListener('click', (e) => {
				if (e.target && e.target.id === 'createNote') {
					createNote();
				}
			});
		</script>
	</body>
</html>
